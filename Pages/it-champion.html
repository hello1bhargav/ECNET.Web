<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IT Champion Checklist Form</title>
    <style>
        body {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 700px;
            margin: 20px auto;
            padding: 20px 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2, h3 {
            text-align: center;
            margin: 10px 0;
        }
        h3 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table td {
            padding: 8px;
            vertical-align: middle;
        }
        table td.label {
            width: 50%;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #f5f5f5;
        }
        .checkbox-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 20px;
        }
        .checkbox-list li {
            margin: 8px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .checkbox-list li.checked {
            background-color: #e8f5e8;
            border-left-color: #4CAF50;
        }
        .checkbox-list input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .send-hod {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #b0d4f1;
        }
        .send-hod label {
            font-weight: bold;
        }
        .verified-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff9f0;
            border-radius: 5px;
            border: 1px solid #ffcc99;
        }
        .verified-section label {
            display: inline-block;
            width: 80px;
            font-weight: bold;
            margin-right: 10px;
        }
        .verified-section input {
            width: 200px;
            padding: 5px;
        }
        #submitBtn {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #submitBtn:hover:not(:disabled) {
            background-color: #45a049;
        }
        #submitBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #note {
            font-size: 0.9em;
            font-style: italic;
            margin-top: 10px;
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .antivirus-details {
            margin-left: 30px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #b0d4f1;
            display: none;
        }
        .antivirus-details label {
            font-weight: normal;
            margin-bottom: 5px;
        }
        .request-info {
            background-color: #e6f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #99ccff;
        }
        .request-info h4 {
            margin-top: 0;
            color: #0066cc;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ELECTRONICS CORPORATION OF INDIA LIMITED</h2>
        <h2>Checklist for Desktop Security Compliance</h2>
        
        <div class="request-info">
            <h4>Request Information</h4>
            <p><strong>Request ID:</strong> <span id="requestId">Loading...</span></p>
            <p><strong>Department:</strong> <span id="department">Loading...</span></p>
            <p><strong>Request Date:</strong> <span id="requestDate">Loading...</span></p>
            <p><strong>Status:</strong> <span id="requestStatus">Loading...</span></p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <h3>Particulars of the Internet Connectivity Point</h3>
        <p style="font-style: italic; font-size: 0.9em; text-align: center;">(To be filled by the IT Champion)</p>
        <table>
            <tr>
                <td class="label"><label for="buildingSwitchIP">Building Switch IP Address</label></td>
                <td><input type="text" id="buildingSwitchIP" placeholder="e.g., 192.168.1.1"></td>
            </tr>
            <tr>
                <td class="label"><label for="buildingSwitchPort">Building Switch Port No.</label></td>
                <td><input type="text" id="buildingSwitchPort" placeholder="e.g., Port 24"></td>
            </tr>
            <tr>
                <td class="label"><label for="accessSwitchIP">Access Switch IP Address</label></td>
                <td><input type="text" id="accessSwitchIP" placeholder="e.g., 192.168.2.1"></td>
            </tr>
            <tr>
                <td class="label"><label for="accessSwitchPort">Access Switch Port No.</label></td>
                <td><input type="text" id="accessSwitchPort" placeholder="e.g., Port 12"></td>
            </tr>
            <tr>
                <td class="label"><label for="ioPort">I/O Port No.</label></td>
                <td><input type="text" id="ioPort" placeholder="e.g., 8080"></td>
            </tr>
        </table>
        
        <h3>Configuration Parameters</h3>
        <ul class="checkbox-list" id="configParams">
            <li>
                <label><input type="checkbox" id="chkLegalOS"> Legal OS and Application Software</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkAntivirus"> Loaded Antivirus (Brand & Version)</label>
                <div class="antivirus-details" id="antivirusDetails">
                    <label for="antivirusInput">Antivirus Brand & Version:</label>
                    <input type="text" id="antivirusInput" placeholder="e.g., McAfee Total Protection v16.0">
                </div>
            </li>
            <li>
                <label><input type="checkbox" id="chkUSB"> Installed USB Pratirodh (Controlled removable media usage)</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkPassword"> Strong Login Password (alphabets/numerals/special chars)</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkSeparate"> Separate Administrator & User accounts</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkRemoteDesktop"> Disabled Remote Desktop features</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkAutorun"> Disabled Auto-run/Auto-play features</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkFirewall"> Enabled Windows Firewall</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkFileSharing"> Turned off File & Printer sharing</label>
            </li>
        </ul>
        
        <h3>Operational Practices</h3>
        <ul class="checkbox-list" id="operationalPractices">
            <li>
                <label><input type="checkbox" id="chkUpdates"> Periodic check of security updates & patches by IT Champion</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkNoAdmin"> Non-use of Administrator account for daily work</label>
            </li>
            <li>
                <label><input type="checkbox" id="chkBackup"> Ensure weekly desktop mail backup using Outlook</label>
            </li>
        </ul>
        
        <div class="send-hod">
            <label for="hodSelect">Send To (HOD):</label>
            <select id="hodSelect">
                <option value="">-- Select HOD --</option>
                <option value="Head_IT">Head of IT</option>
                <option value="Head_Security">Head of Security</option>
                <option value="Head_Admin">Head of Administration</option>
                <option value="Head_Finance">Head of Finance</option>
                <option value="Head_HR">Head of HR</option>
            </select>
        </div>
        
        <div class="verified-section">
            <label for="championCode">Code:</label>
            <input type="text" id="championCode" readonly>
            <label for="championName" style="margin-left: 20px;">Name:</label>
            <input type="text" id="championName" readonly>
            <label for="championDivision" style="margin-left: 20px;">Division:</label>
            <input type="text" id="championDivision" readonly>
        </div>
        
        <button type="submit" id="submitBtn" disabled>Submit Checklist</button>
        
        <p id="note">Note: The IT Champion must verify the above checklist before the submission of ECNET Application form.</p>
        <p style="text-align: center; font-size: 0.8em; margin-top: 30px;">Information Technology Services Division, ITSD</p>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5024/api';
        
        // Get request ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('id') || '1'; // Default to 1 for testing
        
        // Global variables
        let currentRequest = null;
        let allCheckboxes = [];
        
        // DOM elements
        const elements = {
            // Request info
            requestIdSpan: document.getElementById('requestId'),
            departmentSpan: document.getElementById('department'),
            requestDateSpan: document.getElementById('requestDate'),
            requestStatusSpan: document.getElementById('requestStatus'),
            
            // Progress and status
            progressFill: document.getElementById('progressFill'),
            statusMessage: document.getElementById('statusMessage'),
            
            // Form fields
            buildingSwitchIP: document.getElementById('buildingSwitchIP'),
            buildingSwitchPort: document.getElementById('buildingSwitchPort'),
            accessSwitchIP: document.getElementById('accessSwitchIP'),
            accessSwitchPort: document.getElementById('accessSwitchPort'),
            ioPort: document.getElementById('ioPort'),
            
            // Checkboxes
            antivirusCheckbox: document.getElementById('chkAntivirus'),
            antivirusDetails: document.getElementById('antivirusDetails'),
            antivirusInput: document.getElementById('antivirusInput'),
            
            // Selection and champion info
            hodSelect: document.getElementById('hodSelect'),
            championCode: document.getElementById('championCode'),
            championName: document.getElementById('championName'),
            championDivision: document.getElementById('championDivision'),
            
            // Submit button
            submitBtn: document.getElementById('submitBtn')
        };

        // Mock data for when API is not available
        const mockRequestData = {
            id: requestId,
            department: 'Software Development',
            requestDate: new Date().toISOString(),
            status: 'Pending IT Champion Review',
            itChampionCode: 'ITC001',
            itChampionName: 'Rajesh Kumar',
            itChampionDivision: 'Information Technology Services Division'
        };

        // Initialize the page
        async function initializePage() {
            try {
                await loadRequestData();
                await loadChampionData();
                setupEventListeners();
                updateProgress();
                updateSubmitState();
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Error initializing page. Using demo data.', 'error');
                // Load mock data as fallback
                loadMockData();
                setupEventListeners();
                updateProgress();
                updateSubmitState();
            }
        }

        // Load mock data as fallback
        function loadMockData() {
            currentRequest = mockRequestData;
            elements.requestIdSpan.textContent = currentRequest.id;
            elements.departmentSpan.textContent = currentRequest.department;
            elements.requestDateSpan.textContent = new Date(currentRequest.requestDate).toLocaleDateString();
            elements.requestStatusSpan.textContent = currentRequest.status;
            
            elements.championCode.value = currentRequest.itChampionCode;
            elements.championName.value = currentRequest.itChampionName;
            elements.championDivision.value = currentRequest.itChampionDivision;
        }

        // Load request data from API
        async function loadRequestData() {
            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Try to fetch from API
                const response = await fetch(`${API_BASE_URL}/Request/${requestId}`);
                if (!response.ok) {
                    throw new Error('API not available');
                }
                
                currentRequest = await response.json();
                
                // Update request info display
                elements.requestIdSpan.textContent = currentRequest.id;
                elements.departmentSpan.textContent = currentRequest.department;
                elements.requestDateSpan.textContent = new Date(currentRequest.requestDate).toLocaleDateString();
                elements.requestStatusSpan.textContent = currentRequest.status;
                
            } catch (error) {
                // Use mock data if API fails
                throw new Error('API not available - using demo data');
            }
        }

        // Load champion data
        async function loadChampionData() {
            if (currentRequest) {
                elements.championCode.value = currentRequest.itChampionCode || mockRequestData.itChampionCode;
                elements.championName.value = currentRequest.itChampionName || mockRequestData.itChampionName;
                elements.championDivision.value = currentRequest.itChampionDivision || mockRequestData.itChampionDivision;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Get all checkboxes
            allCheckboxes = document.querySelectorAll('#configParams input[type="checkbox"], #operationalPractices input[type="checkbox"]');
            
            // Checkbox event listeners
            allCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Update visual state
                    const listItem = this.closest('li');
                    if (this.checked) {
                        listItem.classList.add('checked');
                    } else {
                        listItem.classList.remove('checked');
                    }
                    
                    updateProgress();
                    updateSubmitState();
                });
            });

            // Antivirus checkbox special handling
            elements.antivirusCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    elements.antivirusDetails.style.display = 'block';
                } else {
                    elements.antivirusDetails.style.display = 'none';
                    elements.antivirusInput.value = '';
                }
                updateSubmitState();
            });

            // Antivirus input validation
            elements.antivirusInput.addEventListener('input', updateSubmitState);

            // HOD selection listener
            elements.hodSelect.addEventListener('change', updateSubmitState);

            // Form field listeners for validation
            const textInputs = [
                elements.buildingSwitchIP,
                elements.buildingSwitchPort,
                elements.accessSwitchIP,
                elements.accessSwitchPort,
                elements.ioPort
            ];

            textInputs.forEach(input => {
                input.addEventListener('input', updateSubmitState);
                input.addEventListener('blur', validateInput);
            });

            // Submit button listener
            elements.submitBtn.addEventListener('click', handleSubmit);
        }

        // Validate individual inputs
        function validateInput(event) {
            const input = event.target;
            const value = input.value.trim();
            
            // IP address validation
            if (input.id.includes('IP') && value) {
                const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
                if (!ipRegex.test(value)) {
                    input.style.borderColor = '#ff4444';
                    showMessage('Please enter a valid IP address format (e.g., 192.168.1.1)', 'error');
                } else {
                    input.style.borderColor = '#4CAF50';
                }
            }
            
            // Port number validation
            if (input.id.includes('Port') && value) {
                const portRegex = /^(Port\s+)?\d+$/i;
                if (!portRegex.test(value)) {
                    input.style.borderColor = '#ff4444';
                } else {
                    input.style.borderColor = '#4CAF50';
                }
            }
        }

        // Update progress bar
        function updateProgress() {
            const totalCheckboxes = allCheckboxes.length;
            const checkedBoxes = Array.from(allCheckboxes).filter(cb => cb.checked).length;
            const progress = Math.round((checkedBoxes / totalCheckboxes) * 100);
            
            elements.progressFill.style.width = progress + '%';
            elements.progressFill.textContent = progress + '%';
            
            // Add visual feedback for completion
            if (progress === 100) {
                elements.progressFill.style.background = 'linear-gradient(90deg, #4CAF50, #2E7D32)';
            } else {
                elements.progressFill.style.background = 'linear-gradient(90deg, #4CAF50, #45a049)';
            }
        }

        // Update submit button state
        function updateSubmitState() {
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const hodSelected = elements.hodSelect.value !== '';
            const networkFieldsFilled = [
                elements.buildingSwitchIP,
                elements.buildingSwitchPort,
                elements.accessSwitchIP,
                elements.accessSwitchPort,
                elements.ioPort
            ].every(field => field.value.trim() !== '');
            
            // Check if antivirus details are filled when antivirus is checked
            const antivirusValid = !elements.antivirusCheckbox.checked || 
                                 elements.antivirusInput.value.trim() !== '';
            
            const canSubmit = allChecked && hodSelected && networkFieldsFilled && antivirusValid;
            
            elements.submitBtn.disabled = !canSubmit;
            
            if (canSubmit) {
                elements.submitBtn.textContent = 'Submit Checklist';
                elements.submitBtn.style.backgroundColor = '#4CAF50';
            } else {
                elements.submitBtn.textContent = 'Complete All Fields';
                elements.submitBtn.style.backgroundColor = '#cccccc';
            }
        }

        // Handle form submission
        async function handleSubmit() {
            if (elements.submitBtn.disabled) return;

            try {
                elements.submitBtn.disabled = true;
                elements.submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
                
                // Collect form data
                const formData = {
                    requestId: requestId,
                    buildingSwitchIP: elements.buildingSwitchIP.value,
                    buildingSwitchPort: elements.buildingSwitchPort.value,
                    accessSwitchIP: elements.accessSwitchIP.value,
                    accessSwitchPort: elements.accessSwitchPort.value,
                    ioPort: elements.ioPort.value,
                    configurationChecks: {
                        legalOS: document.getElementById('chkLegalOS').checked,
                        antivirus: document.getElementById('chkAntivirus').checked,
                        antivirusDetails: elements.antivirusInput.value,
                        usbPratirodh: document.getElementById('chkUSB').checked,
                        strongPassword: document.getElementById('chkPassword').checked,
                        separateAccounts: document.getElementById('chkSeparate').checked,
                        remoteDesktopDisabled: document.getElementById('chkRemoteDesktop').checked,
                        autorunDisabled: document.getElementById('chkAutorun').checked,
                        firewallEnabled: document.getElementById('chkFirewall').checked,
                        fileSharingOff: document.getElementById('chkFileSharing').checked
                    },
                    operationalChecks: {
                        securityUpdates: document.getElementById('chkUpdates').checked,
                        noAdminUse: document.getElementById('chkNoAdmin').checked,
                        weeklyBackup: document.getElementById('chkBackup').checked
                    },
                    selectedHOD: elements.hodSelect.value,
                    championCode: elements.championCode.value,
                    championName: elements.championName.value,
                    championDivision: elements.championDivision.value,
                    submissionDate: new Date().toISOString()
                };

                // Simulate API submission
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                try {
                    // Try to update via API
                    const updateResponse = await fetch(`${API_BASE_URL}/Request/${requestId}/status`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ Status: 'Under Review' })
                    });

                    if (!updateResponse.ok) {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    // Continue with mock success if API fails
                    console.log('API not available, simulating success');
                }

                // Update UI to show success
                elements.requestStatusSpan.textContent = 'Under Review';
                showMessage('✅ Checklist submitted successfully! Request status updated to "Under Review".', 'success');
                
                // Disable form after successful submission
                disableForm();
                
                // Show redirect message
                setTimeout(() => {
                    showMessage('Redirecting to dashboard...', 'success');
                    setTimeout(() => {
                        // In a real application, this would redirect
                        showMessage('Form submitted successfully! In a real application, you would be redirected to the IT Champion Dashboard.', 'success');
                    }, 1000);
                }, 3000);

            } catch (error) {
                console.error('Submission error:', error);
                showMessage('❌ Error submitting checklist: ' + error.message, 'error');
                elements.submitBtn.disabled = false;
                elements.submitBtn.textContent = 'Submit Checklist';
            }
        }

        // Disable form after submission
        function disableForm() {
            // Disable all inputs
            const allInputs = document.querySelectorAll('input, select');
            allInputs.forEach(input => {
                input.disabled = true;
            });
            
            elements.submitBtn.textContent = '✅ Submitted';
            elements.submitBtn.style.backgroundColor = '#2E7D32';
        }

        // Show status message
        function showMessage(message, type) {
            elements.statusMessage.innerHTML = message;
            elements.statusMessage.className = `status-message status-${type}`;
            elements.statusMessage.style.display = 'block';
            
            // Auto-hide error messages after 8 seconds
            if (type === 'error') {
                setTimeout(() => {
                    elements.statusMessage.style.display = 'none';
                }, 8000);
            }
        }

        // Validate form before allowing submission
        function validateForm() {
            const errors = [];
            
            // Check network fields
            const networkFields = [
                { field: elements.buildingSwitchIP, name: 'Building Switch IP' },
                { field: elements.buildingSwitchPort, name: 'Building Switch Port' },
                { field: elements.accessSwitchIP, name: 'Access Switch IP' },
                { field: elements.accessSwitchPort, name: 'Access Switch Port' },
                { field: elements.ioPort, name: 'I/O Port' }
            ];
            
            networkFields.forEach(({ field, name }) => {
                if (!field.value.trim()) {
                    errors.push(`${name} is required`);
                }
            });
            
            // Check checkboxes
            if (!Array.from(allCheckboxes).every(cb => cb.checked)) {
                errors.push('All security checklist items must be completed');
            }
            
            // Check HOD selection
            if (!elements.hodSelect.value) {
                errors.push('Please select a HOD to send the checklist to');
            }
            
            // Check antivirus details if antivirus is selected
            if (elements.antivirusCheckbox.checked && !elements.antivirusInput.value.trim()) {
                errors.push('Antivirus details are required when antivirus is checked');
            }
            
            return errors;
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // Add some demo functionality for testing
        window.addEventListener('load', () => {
            // Auto-fill some demo data after a short delay to show loading state
            setTimeout(() => {
                if (elements.requestIdSpan.textContent === 'Loading...') {
                    loadMockData();
                }
            }, 2000);
        });
    </script>
</body>
</html>